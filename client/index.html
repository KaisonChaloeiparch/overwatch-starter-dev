<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OVERWATCH | Tactical Defense Dashboard</title>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Orbitron:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        tactical: ['Orbitron', 'sans-serif'],
                    },
                    colors: {
                        cyber: {
                            bg: '#050a10',
                            panel: '#0a1420',
                            border: '#1a2b3c',
                            accent: '#00f2ff',
                            danger: '#ff2e2e',
                            warning: '#ffcc00',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #050a10;
            color: #e2e8f0;
        }

        #map {
            height: 100vh;
            width: 100%;
            filter: invert(1) hue-rotate(180deg) brightness(0.8) contrast(1.2);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #1a2b3c;
            border-radius: 10px;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 46, 46, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 46, 46, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 46, 46, 0);
            }
        }

        .pulse-marker {
            animation: pulse-red 2s infinite;
            border-radius: 50%;
            background: #ff2e2e;
        }

        /* Emergency Mode Effects */
        .emergency-active {
            filter: contrast(1.5) brightness(1.1) saturate(1.2);
        }

        .emergency-banner {
            background: repeating-linear-gradient(45deg,
                    #ff2e2e,
                    #ff2e2e 10px,
                    #000 10px,
                    #000 20px);
        }

        @keyframes slide-down {
            from {
                transform: translateY(-100%);
            }

            to {
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="overflow-hidden font-sans transition-all duration-500">

    <!-- Emergency Banner (Hidden by default) -->
    <div id="emergency-banner"
        class="fixed top-14 left-0 right-0 h-8 z-[1001] hidden animate-[slide-down_0.5s_ease-out] emergency-banner flex items-center justify-center border-b border-white/20">
        <span class="font-tactical text-[10px] font-bold text-white tracking-[0.3em]">CRITICAL ALERT: TRAFFIC CONTROL
            ACTIVE - EMERGENCY OVERRIDE ENABLED</span>
    </div>

    <!-- Top Status Bar -->
    <div
        class="fixed top-0 left-0 right-0 h-14 bg-cyber-panel border-b border-cyber-border z-[1000] flex items-center justify-between px-6">
        <div class="flex items-center gap-4">
            <h1 class="font-tactical text-xl font-bold tracking-widest text-cyber-accent">OVERWATCH</h1>
            <div class="h-4 w-[1px] bg-cyber-border"></div>
            <div id="connection-status" class="flex items-center gap-2 text-xs text-gray-400">
                <span class="h-2 w-2 rounded-full bg-red-500 animate-pulse"></span>
                OFFLINE
            </div>
        </div>
        <div class="flex items-center gap-6">
            <button id="override-btn"
                class="bg-cyber-danger/20 hover:bg-cyber-danger/40 border border-cyber-danger text-cyber-danger px-4 py-1 text-[10px] font-tactical tracking-tighter transition-all hover:scale-105 active:scale-95 group relative overflow-hidden">
                <span class="relative z-10">EMERGENCY OVERRIDE</span>
                <div class="absolute inset-0 bg-cyber-danger animate-pulse opacity-20"></div>
            </button>
            <div class="text-xs font-tactical text-gray-500">
                SYSTEM VERSION: 1.0.4 - SOVEREIGN AI
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex h-screen pt-14">
        <!-- Sidebar -->
        <aside class="w-80 bg-cyber-panel border-r border-cyber-border flex flex-col z-[1000]">
            <div class="p-4 border-b border-cyber-border bg-cyber-bg/50">
                <h2 class="font-tactical text-xs font-semibold text-gray-400 uppercase tracking-widest">Incident
                    Logistics</h2>
            </div>
            <div id="incident-list" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-4">
                <!-- Incidents will appear here -->
                <p class="text-xs text-center text-gray-600 italic">Awaiting neural feed...</p>
            </div>
        </aside>

        <!-- Map Area -->
        <section class="flex-1 relative">
            <div id="map"></div>

            <!-- Map HUD -->
            <div class="absolute bottom-6 right-6 z-[1000] flex flex-col gap-2">
                <div class="bg-cyber-panel/80 border border-cyber-border p-3 backdrop-blur-md">
                    <div class="text-[10px] font-tactical text-cyber-accent mb-1 uppercase">Tactical Grid</div>
                    <div class="text-xs text-gray-400">BANGKOK SECTOR: 13.75 - 100.50</div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // --- Initialization ---
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        }).setView([13.7563, 100.5018], 13);

        const SIAM_COORDS = [13.7456, 100.5341];
        let lastIncidentCoords = null;
        let rescuePathLayer = null;
        let isEmergencyMode = false;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const socket = io('http://localhost:3001');
        const incidentList = document.getElementById('incident-list');
        const statusEl = document.getElementById('connection-status');
        const overrideBtn = document.getElementById('override-btn');
        const bannerEl = document.getElementById('emergency-banner');

        // --- Socket Events ---
        socket.on('connect', () => {
            statusEl.innerHTML = '<span class="h-2 w-2 rounded-full bg-green-500"></span> ONLINE';
            statusEl.classList.remove('text-red-500');
            statusEl.classList.add('text-green-500');
        });

        socket.on('disconnect', () => {
            statusEl.innerHTML = '<span class="h-2 w-2 rounded-full bg-red-500 animate-pulse"></span> OFFLINE';
            statusEl.classList.remove('text-green-500');
            statusEl.classList.add('text-red-500');
        });

        socket.on('new_incident', (incident) => {
            console.log('New Neural Feed:', incident);
            lastIncidentCoords = [incident.latitude, incident.longitude];
            addIncidentToUI(incident);
            addMarkerToMap(incident);

            if (isEmergencyMode) {
                drawRescuePath();
            }
        });

        // --- Override Trigger ---
        overrideBtn.addEventListener('click', () => {
            isEmergencyMode = !isEmergencyMode;

            if (isEmergencyMode) {
                document.body.classList.add('emergency-active');
                bannerEl.classList.remove('hidden');
                overrideBtn.innerHTML = 'CANCEL OVERRIDE';
                overrideBtn.classList.replace('bg-cyber-danger/20', 'bg-white/20');
                overrideBtn.classList.replace('text-cyber-danger', 'text-white');
                drawRescuePath();
            } else {
                document.body.classList.remove('emergency-active');
                bannerEl.classList.add('hidden');
                overrideBtn.innerHTML = 'EMERGENCY OVERRIDE';
                overrideBtn.classList.replace('bg-white/20', 'bg-cyber-danger/20');
                overrideBtn.classList.replace('text-white', 'text-cyber-danger');
                if (rescuePathLayer) map.removeLayer(rescuePathLayer);
            }
        });

        // --- Functions ---
        function drawRescuePath() {
            if (rescuePathLayer) map.removeLayer(rescuePathLayer);
            if (!lastIncidentCoords) return;

            rescuePathLayer = L.polyline([SIAM_COORDS, lastIncidentCoords], {
                color: '#39FF14',
                weight: 5,
                opacity: 0.8,
                dashArray: '10, 10',
                lineJoin: 'round'
            }).addTo(map);

            map.fitBounds(rescuePathLayer.getBounds(), { padding: [100, 100] });
        }

        function addIncidentToUI(incident) {
            // Remove placeholder
            if (incidentList.querySelector('p')) incidentList.innerHTML = '';

            const isHigh = incident.priority === 'HIGH';
            const card = document.createElement('div');
            card.className = `p-3 border-l-2 bg-cyber-bg/40 border-cyber-border hover:bg-cyber-bg/80 transition-all ${isHigh ? 'border-l-cyber-danger' : 'border-l-cyber-accent'}`;

            card.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <span class="text-[10px] font-tactical ${isHigh ? 'text-cyber-danger' : 'text-cyber-accent'}">
                        ${incident.type || 'UNCLEAR'}
                    </span>
                    <span class="text-[9px] text-gray-500 uppercase">
                        ${new Date(incident.createdAt).toLocaleTimeString()}
                    </span>
                </div>
                <p class="text-sm text-gray-300 leading-tight">${incident.text}</p>
                <div class="mt-2 text-[9px] text-gray-600 break-all font-mono">
                    ID: ${incident.id.substring(0, 8)}...
                </div>
            `;

            incidentList.prepend(card);
        }

        function addMarkerToMap(incident) {
            const isHigh = incident.priority === 'HIGH';

            const markerIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="${isHigh ? 'pulse-marker' : 'bg-cyber-accent h-3 w-3 rounded-full border border-white'}"></div>`,
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });

            const marker = L.marker([incident.latitude, incident.longitude], { icon: markerIcon }).addTo(map);

            marker.bindPopup(`
                <div class="bg-cyber-panel text-white p-1 rounded border border-cyber-border">
                    <div class="font-tactical text-[10px] mb-1">${incident.type}</div>
                    <div class="text-xs">${incident.text}</div>
                </div>
            `, { closeButton: false });

            if (isHigh) {
                map.panTo([incident.latitude, incident.longitude]);
                marker.openPopup();
            }
        }
    </script>
</body>

</html>